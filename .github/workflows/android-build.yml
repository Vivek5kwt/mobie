name: Build Android APK

permissions:
  contents: write
 
on:
  workflow_dispatch:
    inputs:
      app_id:
        description: "App ID"
        required: true
  repository_dispatch:
    types: [android_build]
 
jobs:
  build:
    runs-on: ubuntu-latest
 
    env:
      APP_ID: ${{ github.event.client_payload.app_id || github.event.inputs.app_id }}
 
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
 
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
 
      - name: Install dependencies
        run: npm install
 
      - name: Show App ID
        run: echo "Building for APP_ID=${APP_ID}"

      - name: Build React with App ID
        env:
          REACT_APP_APP_ID: ${{ env.APP_ID }}
        run: |
          echo "ðŸ”¨ Building React app with REACT_APP_APP_ID=${REACT_APP_APP_ID}"
          echo "ðŸ“± This appId (${REACT_APP_APP_ID}) will be dynamically passed to GraphQL Layouts query"
          npm run build
 
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"
 
      - name: Build Android APK
        run: |
          cd android
          chmod +x ./gradlew
          ./gradlew assembleRelease

      - name: Prepare APK for release
        id: prepare_apk
        run: |
          APK_PATH="android/app/build/outputs/apk/release/app-release.apk"
          APK_NAME="${APP_ID:-app}-${GITHUB_RUN_NUMBER}.apk"
          cp "$APK_PATH" "$APK_NAME"
          echo "apk_name=$APK_NAME" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release with APK
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG_NAME="android-build-${GITHUB_RUN_ID}"
          RELEASE_NAME="Android build ${GITHUB_RUN_NUMBER}"

          gh release create "$TAG_NAME" \
            "${{ steps.prepare_apk.outputs.apk_name }}" \
            --title "$RELEASE_NAME" \
            --notes "Automated Android build for APP_ID=${APP_ID}" \
            --latest=false

          ASSET_URL=$(gh release view "$TAG_NAME" --json assets -q '.assets[0].url')
          {
            echo "### Android build generated"
            echo "- APK: [${{ steps.prepare_apk.outputs.apk_name }}]($ASSET_URL)"
          } >> "$GITHUB_STEP_SUMMARY"
