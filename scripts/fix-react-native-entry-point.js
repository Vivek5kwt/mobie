#!/usr/bin/env node

/**
 * Fixes React Native autogenerated ReactNativeApplicationEntryPoint.java
 * This file is generated by React Native autolinking and may use the old package name
 */

const fs = require('fs');
const path = require('path');

const PACKAGE_NAME = process.env.PACKAGE_NAME || process.argv[2];

if (!PACKAGE_NAME) {
  console.error('❌ PACKAGE_NAME is required');
  console.log('Usage: node scripts/fix-react-native-entry-point.js <package_name>');
  process.exit(1);
}

const reactNativeEntryPointPath = path.join(
  __dirname,
  '..',
  'android',
  'app',
  'build',
  'generated',
  'autolinking',
  'src',
  'main',
  'java',
  'com',
  'facebook',
  'react',
  'ReactNativeApplicationEntryPoint.java'
);

if (!fs.existsSync(reactNativeEntryPointPath)) {
  console.log('⚠️ ReactNativeApplicationEntryPoint.java not found');
  console.log('   This file is generated during build, so it may not exist yet');
  process.exit(0);
}

try {
  let content = fs.readFileSync(reactNativeEntryPointPath, 'utf8');
  const originalContent = content;
  
  // Replace any old package name references to BuildConfig with the new package name
  // Pattern: com.mobidrag.BuildConfig or com.mobidrag.builder.appXXX.BuildConfig -> PACKAGE_NAME.BuildConfig
  content = content.replace(/com\.mobidrag(?:\.builder\.app\d+)?\.BuildConfig/g, `${PACKAGE_NAME}.BuildConfig`);
  
  if (content !== originalContent) {
    fs.writeFileSync(reactNativeEntryPointPath, content, 'utf8');
    console.log(`✅ Fixed ReactNativeApplicationEntryPoint.java with package: ${PACKAGE_NAME}`);
    console.log('   Replaced old BuildConfig references with new package name');
  } else {
    console.log('✅ ReactNativeApplicationEntryPoint.java already has correct package name');
  }
} catch (error) {
  console.error(`❌ Error fixing ReactNativeApplicationEntryPoint.java: ${error.message}`);
  process.exit(1);
}
